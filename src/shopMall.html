<!DOCTYPE html>
<html lang="en">
    <head>
        @@include('layout/meta.html', { "title": "私覓SMEET-e.購物商城", })
        <link rel="stylesheet" href="./css/style.css"/>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"/>
    </head>

    <body>
        @@include('layout/header_01.html')
        <!-- banner -->
        @@include('layout/banner.html',{
            "title":"SHOP",
            "src":"./img/shopmall_img/shopmall_headbanner.jpg"
        })
        <main class="wrapper shopMall" id="app" @click="xxx()">
            <!-- 商城tab+排序 -->
            <div class="shop_up">
                <!-- tab -->
                <!-- <ul class="shop_tab">
                    <li class="shop_tabItem" >
                        <a href="" data-tablink="one" class="on_tab"><h6>主食</h6></a>
                    </li>
                    <li class="shop_tabItem">
                        <a href="" data-tablink="two"><h6>湯品</h6></a>
                    </li>
                    <li class="shop_tabItem">
                        <a href="" data-tablink="three"><h6>甜品</h6></a>
                    </li>
                </ul> -->
                <ul class="shop_tab " style="margin-top: 100px;">
                    <template v-for="tab in shopMall_tab">
                        <li class="shop_tabItem" >
                            <a href="" 
                            class="green-1" 
                            @click.prevent 
                            @click="current_tab = tab.id" 
                            :class="{ on_tab : current_tab ===  tab.id}"><h6>{{ tab.name }}</h6></a>
                        </li>
                    </template>
                </ul>

                <!-- 商品排序 -->
                <select name="" id="">
                    <option value="none" selected disabled hidden>商品排序</option> 
                    <option value="最新">最新</option>
                    <option value="價格：由高到低">價格：由高到低</option>
                    <option value="價格：由低到高">價格：由低到高</option>
                </select>
            </div>
            
            <!-- 商城卡片 -->
            <section class="collect_section ">

                <ul id="three" class="tab-inner">
                    <template 
                    v-for="(item, i) in filtered_list" 
                    :key="item.name">
                
                        <li class="collect_list" data-inside="true">
                            <div>
                                <div class="product_img" data-inside="true">
                                    <a href="./shopMallDetail.html" data-inside="true">
                                        <img :src="item.img" alt="" data-inside="true">
                                    </a>
                                    <i class="fa-solid fa-heart"
                                    :class="{shopMall_checkHeart: item.heart}" 
                                    @click="collect_heart(item)"
                                    @click="addCollectList(item)"
                                    data-inside="true"></i>
                                </div>
                                <div class="product_content green-1" data-inside="true">
                                    <h6 class="product_title" data-inside="true">{{ item.name }}</h6>
                                    <p class="font16" data-inside="true">$<span class="product_money" data-inside="true">{{ item.price }}</span></p>
                                    <button type="button" class="cart_link" href="" data-inside="true">
                                        <i class="fa-solid fa-cart-shopping" 
                                        @click="shopCar(item.id, item.name, item.price, item.img)"
                                        data-inside="true"></i>
                                    </button>

                                    

                                </div>
                            </div>
                        </li>
                    </template>

            </section>

            <!-- 收藏燈箱 -->
            <div class="wrapper overlay1" v-if="success_popup !== '' ">
                
                <article>
                    <div class="check_text">
                        <i class="fa-solid fa-circle-check"></i>
                        <h6 >{{success_popup}}</h6> 
                    </div>
                </article>
            </div>


            <!-- cart 燈箱 -->
            <div class="wrapper product_pop" id="product_pop" v-if="isShow">
                <div class="container" :data-id="this.popupData.id">
                    <i class="fa-solid fa-xmark" id="close_popUp" @click="popUp_xClose(popupData.id, popupData.name, popupData.price, popupData.img)"></i>
                    <div class="img_product">
                        <img :src="popupData.img" alt="">
                    </div>
                    <h6>{{popupData.name}}</h6>
                    <p class="font16">$<span class="money_pop">{{popupData.price}}</span></p>
                    <div class="count_btn">
                        <div class="plus_minus">
                            <!-- 的methods -->
                            <div class="minus" @click="popUpMinus(popupData.amount)"><i class="fa-solid fa-minus" @click=""></i></div>
                            <div class="number">{{popupData.amount}}</div>
                            <!-- 減少的methods -->
                            <div class="plus" @click="popUpPlus(popupData.amount)"><i class="fa-solid fa-plus" @click=""></i></div>
                        </div>
                        <button type="button" class="inCart_btn1" @click="addShoppingCart(popupData, popupData.id)">加入購物車</button>
                    </div>
                </div>
            </div>
        </main>



        
        

        @@include('layout/footer.html')
        <script src="./js/vender/Vue/vue.global.js"></script>
        <script src="./js/vender/Jquery/jquery-3.6.1.js"></script>
        <script>



            const app = Vue.createApp({
                data(){
                    return{
                        // ========= popUp ========= //
                        // 控制卡片 popup 開關
                        isShow:false, 

                        // 燈箱資料，資料源自 MealsInfo
                        popupData: {
                            id: "",
                            img: "",
                            name: "",
                            price: "",
                            amount: 1,
                        },
                        // ========= 收藏後的資料會帶到這裡 ========= //
                        collect_heart_data_list:[],

                        // ========= 點擊購物車的資料會帶到這裡 ========= //
                        ShoppingCartList: [],

                        ShoppingCartListAll: [],

                        
                        // ========= 分頁 ========= // 
                        // 清空原本分頁資料
                        success_popup_interval:null,
                        success_popup:'',

                        // 當前分頁狀態
                        current_tab: "tab1",

                        // 現有分頁的data
                        shopMall_tab:[
                            {
                                id: "tab1",
                                name:"主食"
                            },
                            {
                                id: "tab2",
                                name:"湯品"
                            },
                            {
                                id: "tab3",
                                name:"甜品"
                            }
                        ],

                        // ========= 商品清單 ========= //
                        // 商品清單假資料
                        MealsInfo: [
                            {
                                category:'tab1',
                                id: "1",
                                img: "./img/shopmall_img/shopmall_product01.jpg",
                                heart: false,
                                name: "黑鮪刺身",
                                price: "700",
                                collectTime: new Date(),
                                amount:3
                            },
                            {
                                category:'tab1',
                                id: "2",
                                img: "./img/shopmall_img/shopmall_product02.jpg",
                                heart: false,
                                name: "北海道海膽壽司",
                                price: "700",
                                collectTime: new Date(),
                                amount:5
                            },
                            {
                                category:'tab1',
                                id: "3",
                                img: "./img/shopmall_img/shopmall_product03.jpg",
                                heart: false,
                                name: "蘆筍蝦手捲",
                                price: "700",
                                collectTime: new Date(),
                                amount:3
                            },
                            {
                                category:'tab2',
                                id: "4",
                                img: "./img/shopmall_img/shopmall_product04.jpg",
                                heart: false,
                                name: "極品生魚片",
                                price: "700",
                                collectTime: new Date(),
                                amount:7
                            },
                            {
                                category:'tab2',
                                id: "5",
                                img: "./img/shopmall_img/shopmall_product05.jpg",
                                heart: false,
                                name: "番茄海鮮清湯",
                                price: "700",
                                collectTime: new Date(),
                                amount:2
                            },
                            {
                                category:'tab2',
                                id: "6",
                                img: "./img/shopmall_img/shopmall_product06.jpg",
                                heart: false,
                                name: "奶香牛肝菌野菇濃湯",
                                price: "700",
                                collectTime: new Date(),
                                amount:9
                            },
                            {
                                category:'tab3',
                                id: "7",
                                img: "./img/shopmall_img/shopmall_product07.jpg",
                                heart: false,
                                name: "手沖牛肉湯",
                                price: "700",
                                collectTime: new Date(),
                                amount:17
                            },
                            {
                                category:'tab3',
                                id: "8",
                                img: "./img/shopmall_img/shopmall_product08.jpg",
                                heart: false,
                                name: "酒焰龍蝦盛宴",
                                price: "700",
                                collectTime: new Date(),
                                amount:6
                            },
                            {
                                category:'tab3',
                                id: "9",
                                img: "./img/shopmall_img/shopmall_product10.jpg",
                                heart: false,
                                name: "繡球花和菓子",
                                price: "700",
                                collectTime: new Date(),
                                amount:11
                            },
                        ],
                    };
                },
                computed: {
                    // 原本菜單陣列依照curren_tab過濾
                    filtered_list(){
                        const filtered =  this.MealsInfo.filter((post) => {
                        return this.current_tab === post.category
                            // return  post.title.toLowerCase().includes(this.keyword.toLowerCase());
                        });
                        return filtered
                    }
                },

                methods: {
                    // TODO 怎麼觸及燈箱以外的地方，就可以讓燈箱關閉（目前在html結構上加上data-inside=”true“來判斷），但是這樣會報錯
                    // xxx(){
                    //     const target = e.target

                    //     if (!target.matches('[data-inside]')) { 
                    //         this.isShow = false;
                    //     }
                    // },

                    // ========= 購物車行為 ========= //

                    // 點擊卡片購物車 icon 後 顯示 popUp
                    shopCar(id, name, price, img){
                        // 開啟popUp
                        this.isShow = true;

                        // asign 資料到popUp
                        this.popupData.name = name
                        this.popupData.id = id
                        this.popupData.price = price
                        this.popupData.img = img
                    },

                    // 點擊 X 關閉popUp並清空資料
                    popUp_xClose(id, name, price, img){
                        // 關閉popUp
                        this.isShow = false;
                        // 清空資料
                        this.popupData.amount = 1;
                    },

                    // 商品數量加
                    popUpPlus(amount){
                        // console.log(amount);
                        this.popupData.amount ++;
                    },
                    // 商品數量減
                    popUpMinus(amount){
                        // console.log(amount);
                        if(this.popupData.amount > 1){
                            this.popupData.amount --;
                        }
                    },
                    
                    // FIXME 還沒想到怎麼將陣列中重復的值相加
                    // addShoppingCart(popupData, id){
                        
                        // asign 資料到popUp
                        // this.ShoppingCartList.id = popupData.id
                        // console.log(this.ShoppingCartList.id); // 值為：1
                        
                        // this.ShoppingCartList.push(popupData);
                        

                        // const cacheData = [];
                        // const newData = [];
                        // console.log(this.ShoppingCartList); // 得到商品物件
                        // let shopCartLi = this.ShoppingCartList;

                        // shopCartLi.forEach((item) => {
                            
                        //     // 避免陣列第0筆一開始就上傳，所以預設就-1
                        //     const str = item.id - 1;

                        //     if (typeof cacheData[str] === 'undefined') {
                        //         cacheData[str] = item;
                        //         console.log(cacheData);
                        //     } else {
                        //         parseInt(cacheData[str].amount) + parseInt(item.amount);
                        //     }
                        // });

                        // 關閉購物車
                        // this.isShow = false;

                        // 數量回到初始值
                        // this.popupData.amount = 1;
                    // },

                    // 點擊加入購物車 資料存到 loacalStorage，且關閉popUp
                    // save_shoppingData(shoppingData){
                    //     localStorage.setItem("shoppingData", JSON.stringify(popupData));
                    // },

                    // ========= 商品收藏 ========= //

                    // 收藏商品資料加入空陣列
                    addCollectList(item){
                        // console.log(item);
                        // push 到新的陣列以便存到 localStorage
                        this.collect_heart_data_list.push(item);
                    },

                    // 收藏商品資料移除
                    removeCollectList(item){
                        this.collect_heart_data_list.shift(item);
                    },


                    // 商品愛心收藏及移除（樣式及提醒popUp）
                    collect_heart(item){
                        // 加减爱心
                        console.log(item.heart);
                        if(item.heart == true){
                            item.heart = false;
                            this.success_popup = '移除收藏成功'
                            this.removeCollectList(item)

                        }else{
                            item.heart = true;
                            this.success_popup = '加入收藏成功'
                            this.addCollectList(item)
                        }

                        // 收藏 & 移除 PopOn 消失
                        clearInterval(this.success_popup_interval)
                        this.success_popup_interval = setInterval(() => {
                            this.success_popup= ''
                        }, 1000);

                        // 收藏增加 LoacalStorage
                        // console.log(this.collect_heart_data_list);
                        localStorage.setItem("shopCollect", JSON.stringify(this.collect_heart_data_list));
                    },

                },
            });

            const vm = app.mount("#app");

            


        </script>
    </body>
</html>