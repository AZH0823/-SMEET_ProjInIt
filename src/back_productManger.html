<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"/>
    <title>顧客評價</title>
</head>
<body>
    <!-- ============== 缺搜尋BAR ============== -->
    <div class="back_productManger fulid_wrapper">
        <div class="backwrapper">
            <header>
                @@include('layout/back_header.html')
            </header>

            <div class="container" id="app">
                <main class="right_content">
                    <section class="section1">
                        <!-- form -->
                        <div class="back_from">

                            <div class="title">
                                <h4 class="h4 green-1">商城商品上架</h4>
                                <div class="insert_btn font16">
                                    <p class="font16" @click="openPop()">新增</p>
                                </div>
                            </div>
                            
                            <div class="back_from_wrapper">
    
                                    <!-- row-1 -->
                                <div class="grid_container">
                                    <div class="grid_item">商品編號</div>
                                    <div class="grid_item">分類</div>
                                    <div class="grid_item">品名</div>
                                    <div class="grid_item">售價</div>
                                    <div class="grid_item">狀態</div>
                                </div>

                                <!-- row-2 -->
                                <div class="grid_container" v-for="item in product" :key="item.ID">
                                    <div class="grid_item checked">{{ item.ID }}</div>
                                    <div class="grid_item">{{ item.Type }}</div>
                                    <div class="grid_item">{{ item.Name }}</div>
                                    <div class="grid_item">{{ item.Price }}</div>
                                    <div class="grid_item">
                                        <label class="switch">
                                            <input type="checkbox" class="switch_btn" :checked="item.Condition === 1" @click="switchToggle(item, $event)">
                                            <span class="slider"></span>
                                            <p class="slider_content" v-if="item.Condition === 1">上架</p>
                                            <p class="slider_content" v-if="item.Condition === 0">下架</p>
                                        </label>
                                    </div>
                                </div>
                            </div><!-- wrapper -->
                        </div><!-- back_from -->
                        
                        <!-- 頁碼-->
                        <!-- <div class="page">
                            <ul class="page_ul">
                            <li><a href="#">1</a></li>
                            <li><a href="#">2</a></li>
                            <li><a href="#">3</a></li>
                            <li><a href="#">4</a></li>
                            </ul>
                        </div> -->
                    </section><!-- section1 -->
                    <div class="product_wrapper fulid_wrapper" v-if="isShow" @click="product_pop_close">
                        <div class="section_products" @click.stop>
                            <div class="product_top">
                                <p>新增商品</p>
                            </div>
                            <div class="product_main">
                                <div class="product_name">
                                    <h6>商品名稱：<input placeholder="春手毬和菓子(6/25)" v-model="popupData.Name" required></h6>
                                    
                                </div>
                                <div class="product_type">
                                    <h6>商品分類：<select name="" id="" @change="UpadteCondition()" v-model="popupData.Type" required>
                                        <option value="商城主食">商城主食</option>
                                        <option value="商城湯品">商城湯品</option>
                                        <option value="商城甜品">商城甜品</option>
                                    </select></h6>
                                </div>
                                <div class="product_price">
                                    <h6>建議售價：<input placeholder="$700" v-model.number="popupData.Price" required></h6>
                                </div>
                                <div class="product_shopkp">
                                    <h6>重點敘述：</h6>
                                    <textarea v-model.trim="popupData.ShopPoint" placeholder="你可以在這邊輸入有關產品的重點介紹..." maxlength="500" required></textarea>
                                </div>
                                <div class="product_intro">
                                    <h6>詳情簡介：</h6>
                                    <textarea v-model.trim="popupData.Introduction" placeholder="你可以在這邊輸入有關產品的詳細介紹..." maxlength="500" required></textarea>
                                </div>
                                <div class="product_pic">
                                    <label type="button" class="btn">
                                        <span>圖片：</span>
                                        <input type="file" 
                                        multiple
                                        onchange="openFile(event)" name="dish_IMG">
                                        <img id="output" height="200" style="display:none">
                                    </label>    
                    </label>    
                                    </label>    
                                </div>
                                <!-- <div class="product_trans">
                                    <h6>配送方式：</h6>
                                    <h6>白貓宅配 ○</h6>
                                    <h6>超商取貨 ●</h6>
                                </div> -->
                                <button class="product_content_btn" type="submit" @click="doSubmit()">儲存</button>
                
                            </div>
                        </div>
                    </div>


                    <!-- ========== 加入商品成功 & 移除商品成功 燈箱 ========== -->
                    <div class="overlay1" :class="{ product_popNone : success_popup ==''}"  v-if="success_popup !== '' ">
                        
                        <article>
                            <div class="check_text">
                                <i class="fa-solid fa-circle-check"></i>
                                <h6>{{success_popup}}</h6> 
                            </div>
                        </article>
                    </div>
                    

                </main>
                @@include('layout/back_footer.html')
            </div><!-- container -->
        </div>
        
        
    </div>
    <script src="./js/vender/Vue/vue.global.js"></script>
    <script src="./js/vender/Jquery/jquery-3.6.1.js"></script><!-- JQ -->
    <script
        type="module"
        src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script><!-- icon_cdn -->
    <script
        nomodule="nomodule"
        src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script><!-- icon_cdn -->
        <script src="./js/back_page/back_nav/back_nav.js"></script><!-- 導覽列 -->
    <script>


        // fileReader
        function openFile(event){
            var input = event.target; //取得上傳檔案
            var reader = new FileReader(); //建立FileReader物件

            reader.readAsDataURL(input.files[0]); //以.readAsDataURL將上傳檔案轉換為base64字串

            reader.onload = function(){ //FileReader取得上傳檔案後執行以下內容
                var dataURL = reader.result; //設定變數dataURL為上傳圖檔的base64字串
                $('#output').attr('src', dataURL).show(); //將img的src設定為dataURL並顯示
            };
        }


        // Vue
        const app = Vue.createApp({
            data() {
                return {

                    text:{
                        put_on: '上架',
                        put_down: '下架'
                    },

                    // 接Ajax的產品資料
                    product: [],

                    // popUp的資料, insert 到資料庫
                    popupData: {
                        // ID: '', 資料庫設定是autoID
                        Type: '商城主食',
                        Name: "",
                        Price: "",
                        ShopPoint: "",
                        Introduction: "",
                        IMG: "",
                        pushisedDate: Date.now()
                    },

                    // 當前 Switch 狀態
                    currentState: true,

                    // ========= popUp ========= // 

                    // 控制燈箱
                    isShow: false,

                    // 控制popUp開關
                    success_popup:'',

                    // 清空原本popUp資料
                    success_popup_interval:null,
                }
            },
            watch: {
                // "popupData.ShopPoint": function(){
                //     console.log(this.popupData.ShopPoint);
                // }
            },
            computed: {
                
            },
            created() {

                // 取得現有商品資料
                this.getCate();
            },
            mounted() {
                
                
            },
            methods: {

                // 取得商品清單
                getCate(){    
                    $.ajax({            

                        method: "GET",
                        url: "./php/backpage/back_productManger_s.php",
                        data:{},
                        dataType: "json",
                        success: (response)=> {
                            if(response != ""){
                                console.log(response);
                                for (let i = 0; i < response.length; i++) {
                                    const element = response[i];
                                    // console.log(element.Condition);
                                    // 修改 Type 值
                                    if(response[i].Type == 8 ){
                                        response[i].Type = "主食"
                                    }
                                    else if(response[i].Type == 9 ){
                                        response[i].Type = "湯品"
                                    }
                                    else if(response[i].Type == 10 ){
                                        response[i].Type = "甜品"
                                    };
                                    
                                
                                }   
                                
                                // 將資料存到 Vue.Data
                                this.product = response;
                            }                
                        },
                        error: (exception)=> {
                            alert("數據載入失敗: " + exception.status);
                        }
                    });
                },


                updateOrderDishCondition(dish){
                    console.log(dish);
                    // 修改資料庫資料
                    $.ajax({            
                        method: "POST",
                        // TODO update API 尚未完成
                        url: "./php/backpage/back_productManger_u.php",
                        data:{
                            dish_ID : dish.ID,
                            dish_Condition : dish.Condition
                        },
                        dataType: "text",
                        success: (response)=> {
                            console.log(response)
                        },
                        error: (exception)=> {
                            alert("數據載入失敗: " + exception.status);
                        }
                    });
                },
                

                // switch update status
                // FIXME 改變樣式，將 Condition的值存到一個變數回傳資料庫

                switchToggle(dish, e){
                    if(window.confirm('是否要更商品狀態?')){
                        if(dish.Condition ==1){
                            dish.Condition = 0;
                        }else{
                            dish.Condition = 1;
                        } 
                        // updata  Condition API
                        this.updateOrderDishCondition(dish);
                    }else{
                        // console.log(e.target.checked)
                        // console.log(dish.Condition)
                        e.target.checked = dish.Condition
                    }
                    
                },


                // 點擊 insert 打開 popUp
                openPop(){
                    // 開啟popUp
                    this.isShow = true;

                    // overfloat: hidden
                    let body = document.querySelector('body');
                    body.style.overflow = "hidden";

                    
                },



                // FIXME Insert 資料 
                doSubmit(){
                    
                    // 判斷資料格式是否正確
                    if (this.popupData.Name == '') {
                        alert("請填寫[商品名稱]");
                        return false;
                    }
                    if (this.popupData.Price == '') {
                        alert("請填寫[商品售價]");
                        return false;
                    }
                    // else if(this.popupData.Price !== typeof(Number)){
                    //     alert("請填寫[商品售價]正確格式");
                    //     return false;
                    // }

                    // console.log(e.which);
                        // // 0 ~ 9 之間對應數值為 48 ~ 57 , 8 為 回車鍵

                        // if((e.which >= 48 && e.which <= 57) || e.which == 8){
                        // if(e.target.value.length == 0 && e.which == 8){
                        //     let previous_el = this.previousElementSibling;
                        //     console.log(previous_el);
                        //     previous_el.focus();
                        // }
                        // }else{
                        // e.preventDefault();
                        // }
                    


                    if (this.popupData.ShopPoint == '') {
                        alert("請填寫[商品重點敘述]");
                        return false;
                    }    
                    if (this.popupData.Introduction == '') {
                        alert("請填寫[商品詳細敘述]");
                        return false;
                    }    
                    

                    // 處理 dish_Type 資料格式
                    if(this.popupData.Type == "商城主食" ){
                        this.popupData.Type = 8
                        const dish_Type = this.popupData.Type;
                    }
                    else if(this.popupData.Type == "商城湯品" ){
                        this.popupData.Type = 9
                        const dish_Type = this.popupData.Type;
                    }
                    else if(this.popupData.Type == "商城甜品" ){
                        this.popupData.Type = 10
                        const dish_Type = this.popupData.Type;
                    };
                    
                    // 宣告變數
                    const dish_Type = this.popupData.Type;
                    const dish_Name = this.popupData.Name;
                    const dish_Price = this.popupData.Price;
                    const dish_ShopPoint = this.popupData.ShopPoint;
                    const dish_Introduction = this.popupData.Introduction; 

                    // FIXME How to send and get the IMG ？
                    const dish_IMG = this.popupData.IMG;
                    
                    // console.log(dish_Type);
                    // console.log(dish_Name);
                    // console.log(dish_Price);
                    // console.log(dish_ShopPoint);
                    // console.log(dish_Introduction);

                    $.ajax({            
                        method: "POST",
                        url: "php/backpage/back_productManger_i.php",
                        data:{
                            dish_Type,
                            dish_Name,
                            dish_Price,
                            dish_ShopPoint,
                            dish_Introduction,
                            dish_IMG,
                        },            
                        dataType: "text",
                        success: (response)=> {
                            // 加入商品成功 popUp
                            this.success_popup = '新增商品成功'
                            let body = document.querySelector('body');
                            body.style.overflow = "hidden";

                            // PopOn 消失
                            clearInterval(this.success_popup_interval)
                            this.success_popup_interval = setInterval(() => {
                                this.success_popup= ''
                                // overfloat: auto
                                let body = document.querySelector('body');
                                body.style.overflow = "auto";
                            }, 1000);
                        },
                        error: function(exception) {
                            alert("數據載入失敗: " + exception.status);
                        }
                    });

                    // 清空popupData資料
                    this.popupData = {
                        Type: '商城主食',
                        Name: "",
                        Price: "",
                        ShopPoint: "",
                        Introduction: "",
                        IMG: "",
                        pushisedDate: Date.now()
                    },
                    // 關閉popUp
                    this.isShow = false;
                },


                // 點擊 container 關掉 popUp
                product_pop_close(){
                    this.isShow = false;

                    // overfloat: auto
                    let body = document.querySelector('body');
                    body.style.overflow = "auto";

                    // 清空資料
                    this.popupData = {
                        // ID: '', 資料庫設定是autoID
                        Type: '商城主食',
                        Name: "",
                        Price: "",
                        ShopPoint: "",
                        Introduction: "",
                        IMG: "",
                        pushisedDate: Date.now()
                    }
                },
                
                
            },

        });
        const vm = app.mount("#app");
    </script>
</body>
</html>